{"version":3,"sources":["ddz_WeChatAppManager.js"],"names":["app","require","ddz_WeChatAppManager","BaseClass","extend","Init","JS_Name","subGameName","ShareDefine","ddz_ShareDefine","HeroAccountManager","ddz_HeroAccountManager","NetManager","ddz_NetManager","LocalDataManager","ComTool","ddz_ComTool","dataInfo","OnReload","ReceivePrepayOrder","serverPack","prepayOrderInfo","argDict","argList","JSON","stringify","error","ErrLog","stack","ddz_SDKManager","CheckIsAppCheck","ddz_NativeManager","CallToNative","ProductID","Login","accessTokenInfo","GetConfigProperty","sdkToken","sdkAccountID","SendLoginByWeChatAuthorization","CheckLoginBySDK","ShareText","title","flag","Share","description","urlStr","ShareImage","imagePath","ShareScreen","shareType","cc","sys","isNative","filePath","Capture","GetSDKProperty","property","hasOwnProperty","GetSDK","OnNativeNotifyWXLogin","dataDict","errCode","code","IsDoLogining","director","getScene","_sgNode","scheduleOnce","ddz_SysNotifyManager","ShowSysMsg","OnNativeNotifyWXShare","console","log","ddz_FormManager","CloseForm","isShow","IsFormShow","GetFormComponentByFormName","Event_ShareSuccess","OnEvent","OnNativeNotifyWXPay","token","mpID","GetClientConfigProperty","LoginAccountBySDK","SDKType_WeChatApp","node","Node","parent","camera","addComponent","Camera","x","winSize","width","y","height","cullingMask","texture","RenderTexture","gl","game","_renderContext","initWithSize","STENCIL_INDEX8","targetTexture","render","data","readPixels","Math","floor","picData","Uint8Array","rowBytes","row","srow","start","reStart","i","CC_JSB","name","Date","now","jsb","fileUtils","getWritablePath","success","saveImageData","destroy","g_ddz_WeChatAppManager","exports","GetModel"],"mappings":"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","file":"ddz_WeChatAppManager.js","sourceRoot":"../../../../../assets/script/sdk","sourcesContent":["/**\r\n * Created by guoliangxuan on 2017/3/16.\r\n */\r\n/**\r\n * WeChatAppManager.js 微信appSDK.\r\n */\r\nvar app = require(\"ddz_app\");\r\n\r\nvar ddz_WeChatAppManager = app.BaseClass.extend({\r\n    Init:function() {\r\n        this.JS_Name = app.subGameName + \"_WeChatAppManager\";\r\n\r\n        this.ShareDefine = app.ddz_ShareDefine();\r\n        this.HeroAccountManager = app.ddz_HeroAccountManager();\r\n        this.NetManager = app.ddz_NetManager();\r\n        this.LocalDataManager = app.LocalDataManager();\r\n        this.ComTool = app.ddz_ComTool();\r\n\r\n\t    this.dataInfo = {};\r\n\r\n\t    //this.OnReload();\r\n    },\r\n\r\n\tOnReload:function(){\r\n\t},\r\n\r\n\t//---------------接收函数-------------------\r\n\t//收到预订单信息\r\n\tReceivePrepayOrder:function(serverPack){\r\n\t\tlet prepayOrderInfo = serverPack[\"PrepayOrderInfo\"];\r\n\r\n\t\tlet argDict = prepayOrderInfo[\"ArgDict\"];\r\n\t\tlet argList = [];\r\n\t\ttry{\r\n\t\t\targList = [{\"Name\":\"OrderJson\", \"Value\":JSON.stringify(argDict)}];\r\n\t\t}catch (error){\r\n\t\t\tthis.ErrLog(\"ReceivePrepayOrder error:%s\", error.stack);\r\n\t\t\treturn\r\n\t\t}\r\n\t\tif (app.ddz_SDKManager().CheckIsAppCheck())  {\r\n\t\t\tapp.ddz_NativeManager().CallToNative(\"BuyAppStoreShop\", [{\"Name\":\"BuyType\", \"Value\":prepayOrderInfo.ProductID-1}]);\r\n\t\t} else {\r\n\t\t\tapp.ddz_NativeManager().CallToNative(\"OnWeChatPay\", argList);\r\n\t\t}\r\n\t},\r\n\r\n\t//------------调用接口---------------\r\n\t//微信授权\r\n\tLogin:function(){\r\n\r\n\t\t//如果本地缓存了accessToken\r\n\t\tlet accessTokenInfo = this.LocalDataManager.GetConfigProperty(\"Account\", \"AccessTokenInfo\");\r\n\t\tlet sdkToken = \"\";\r\n\t\tlet sdkAccountID = 0;\r\n\t\t//直接登录服务器\r\n\t\tif(accessTokenInfo){\r\n\t\t\tsdkToken = accessTokenInfo[\"SDKToken\"];\r\n\t\t\tsdkAccountID = accessTokenInfo[\"AccountID\"];\r\n\t\t}\r\n\r\n\t\tif(sdkAccountID && sdkToken){\r\n\t\t\t//使用上次的授权缓存token\r\n\t\t\tthis.SendLoginByWeChatAuthorization(sdkToken, sdkAccountID);\r\n\t\t}\r\n\t\telse{\r\n\t\t\tapp.ddz_NativeManager().CallToNative(\"OnWeChatLogin\", []);\r\n\t\t}\r\n\r\n\t},\r\n\r\n\t//检查登录是否是短线重登\r\n\tCheckLoginBySDK:function(){\r\n\t\t//如果本地缓存了accessToken\r\n\t\tlet accessTokenInfo = this.LocalDataManager.GetConfigProperty(\"Account\", \"AccessTokenInfo\");\r\n\t\tlet sdkToken = \"\";\r\n\t\tlet sdkAccountID = 0;\r\n\t\t//直接登录服务器\r\n\t\tif(accessTokenInfo){\r\n\t\t\tsdkToken = accessTokenInfo[\"SDKToken\"];\r\n\t\t\tsdkAccountID = accessTokenInfo[\"AccountID\"];\r\n\t\t}\r\n\r\n\t\tif(sdkAccountID && sdkToken){\r\n\t\t\tthis.ErrLog(\"CheckLoginBySDK sdkaccountid and sdktoken have\");\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tthis.ErrLog(\"CheckLoginBySDK sdkaccountid and sdktoken not have\");\r\n\t\treturn false;\r\n\t},\r\n\tShareText:function(title,flag){\r\n\t\tlet argList = [{\"Name\":\"Text\",\"Value\":title},{\"Name\":\"Flag\",\"Value\":flag}];\r\n\t\tapp.ddz_NativeManager().CallToNative(\"OnWeChatShareText\",argList);\r\n\t},\r\n\t//微信分享\r\n\tShare:function(title, description, urlStr, flag, argDict){\r\n\t\tif(!argDict){\r\n\t\t\targDict = {};\r\n\t\t}\r\n\t\tlet argList = [{\"Name\":\"Title\",\"Value\":title},{\"Name\":\"Description\",\"Value\":description},{\"Name\":\"URL\",\"Value\":urlStr},{\"Name\":\"Type\",\"Value\":flag}];\r\n\t\tapp.ddz_NativeManager().CallToNative(\"OnWeChatShare\", argList);\r\n\t},\r\n\r\n\tShareImage:function(imagePath, flag){\r\n\t\tlet argList = [{\"Name\":\"ImagePath\",\"Value\":imagePath},{\"Name\":\"Type\",\"Value\":flag}];\r\n\t\t//app.ddz_NativeManager().CallToNative(\"OnWeChatShare\", argList);\r\n\t\tapp.ddz_NativeManager().CallToNative(\"OnWeChatShareImage\", argList);\r\n\t},\r\n\r\n\t//全屏分享(0:分享到微信好友，1：分享到微信朋友圈 shareType：字符串)\r\n\tShareScreen:function(shareType){\r\n\t\t//this.SysLog(\"ShareScreen  00000\");\r\n\t\t//默认发给朋友\r\n\t\tif(!shareType){\r\n\t\t\tshareType = \"0\";\r\n\t\t}\r\n\r\n\t\tif(!cc.sys.isNative){\r\n\t\t\tthis.ErrLog(\"ShareScreen not native\");\r\n\t\t\treturn\r\n\t\t}\r\n\t\tlet filePath = this.Capture();\r\n        if (filePath != \"\") {\r\n        \tthis.ShareImage(filePath, shareType);\r\n        }\r\n\t},\r\n\r\n\t//----------------获取接口------------------------\r\n\r\n\tGetSDKProperty:function(property){\r\n\t\tif(!this.dataInfo.hasOwnProperty(property)){\r\n\t\t\tthis.ErrLog(\"GetSDKProperty not find property:%s\", property);\r\n\t\t\treturn\r\n\t\t}\r\n\t\treturn this.dataInfo[property];\r\n\t},\r\n\r\n\tGetSDK:function(){\r\n\t\treturn {};\r\n\t},\r\n\r\n\t//--------------回调接口-----------------------------\r\n\r\n    //微信登录\r\n\tOnNativeNotifyWXLogin:function(dataDict){\r\n        let errCode = dataDict[\"ErrCode\"];\r\n\r\n\t\t//0:成功\r\n\t\t//-1:普通错误类型,\r\n\t\t//-2:用户点击取消并返回\r\n\t\t//-3:发送失败\r\n\t\t//-4:授权失败\r\n\t\t//-5:微信不支持\r\n\r\n\t\tif(errCode == 0){\r\n\t\t\tthis.dataInfo = dataDict;\r\n\t\t\tlet code = this.dataInfo[\"Code\"];\r\n\t\t\tif(!code){\r\n\t\t\t\tthis.ErrLog(\"SendLoginByWeChatAuthorization not find Code:\", this.dataInfo);\r\n\t\t\t\tthis.HeroAccountManager.IsDoLogining(false);\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\tthis.SendLoginByWeChatAuthorization(code, 0);\r\n\t\t}\r\n\t\telse if(errCode == -2){\r\n\t\t\t// this.SysLog(\"OnNativeNotifyWXLogin Cancel\");\r\n\t\t\tcc.director.getScene()._sgNode.scheduleOnce(function(){\r\n\t\t\t\tapp.ddz_SysNotifyManager().ShowSysMsg(\"CodeErrorMsg\", [\"微信授权失败\"]);\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tthis.HeroAccountManager.IsDoLogining(false);\r\n\t\t}\r\n\t\telse{\r\n\t\t\t// this.ErrLog(\"OnNativeNotifyWXLogin dataDict:\", dataDict);\r\n\t\t\tcc.director.getScene()._sgNode.scheduleOnce(function(){\r\n\t\t\t\tapp.ddz_SysNotifyManager().ShowSysMsg(\"CodeErrorMsg\", [\"微信授权失败\"]);\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tthis.HeroAccountManager.IsDoLogining(false);\r\n\t\t}\r\n\r\n    },\r\n\r\n    //微信分享\r\n    OnNativeNotifyWXShare:function(dataDict){\r\n    \tconsole.log(\"OnNativeNotifyWXShare:\",dataDict);\r\n    \t// this.SysLog(\"OnNativeNotifyWXShare dataDict:\"+dataDict);\r\n        let errCode = dataDict[\"ErrCode\"];\r\n\t    //0:分享成功\r\n\t    //-1:普通错误类型,\r\n\t    //-2:用户点击取消并返回\r\n\t    //-3:发送失败,\r\n\t    //-4:授权失败,\r\n\t    //-5:微信不支持,\r\n\t    // this.SysLog(\"OnNativeNotifyWXShare errCode:\"+errCode);\r\n\t    if(errCode == 0){\r\n\t        //this.SysLog(\"OnNativeNotifyWXShare Request:CPlayerReceiveShare\");\r\n\t    \t//app.ddz_NetManager().SendPack(\"game.CPlayerReceiveShare\",{});\r\n\t    \tapp.ddz_FormManager().CloseForm('game/base/ui/majiang/UIMJSharePaiXingMax');\r\n\t    \tlet isShow=app.ddz_FormManager().IsFormShow('game/base/ui/majiang/UIMJSharePaiXingMini');\r\n\t    \t// this.SysLog(\"OnNativeNotifyWXShare UIMJSharePaiXingMini isShow:\"+isShow);\r\n\t    \tif(isShow){\r\n\t    \t\t// this.SysLog(\"OnNativeNotifyWXShare UIMJSharePaiXingMini Event_ShareSuccess\");\r\n\t    \t\tapp.ddz_FormManager().GetFormComponentByFormName(\"game/base/ui/majiang/UIMJSharePaiXingMini\").Event_ShareSuccess(false);\r\n\t    \t\treturn;\r\n        \t}\r\n\t    \tapp[app.subGameName + \"Client\"].OnEvent(\"ShareSuccess\",\"\");\r\n\t    \tapp[app.subGameName + \"Client\"].OnEvent(\"ChouJiangShareSuccess\",\"\"); \r\n\t    }\r\n\t    //用户点击取消并返回\r\n\t    else if(errCode == -2){\r\n\t\t\t// this.SysLog(\"OnNativeNotifyWXShare Cancel\");\r\n\t    }\r\n\t    else{\r\n\t\t    this.ErrLog(\"OnNativeNotifyWXShare:\", dataDict);\r\n\t\t    app.ddz_SysNotifyManager().ShowSysMsg(\"CodeErrorMsg\", [\"微信分享失败:\" + errCode]);\r\n\t    }\r\n    },\r\n\r\n    //微信支付\r\n    OnNativeNotifyWXPay:function(dataDict){\r\n\r\n        let errCode = dataDict[\"ErrCode\"];\r\n\t    //0:支付成功\r\n\t    if(errCode == 0){\r\n\r\n\t    }\r\n\t    else if(errCode == -2){\r\n\t\t    // this.SysLog(\"OnNativeNotifyWXPay Cancel\");\r\n\t    }\r\n\t    else{\r\n\t\t    this.ErrLog(\"OnNativeNotifyWXPay:\", dataDict);\r\n\t\t    app.ddz_SysNotifyManager().ShowSysMsg(\"CodeErrorMsg\", [\"支付失败:\" + errCode]);\r\n\t    }\r\n    },\r\n\r\n    //----------------发包接口------------------------\r\n\t//发送授权登录\r\n    SendLoginByWeChatAuthorization:function(token, sdkAccountID){\r\n\r\n\t    let mpID = app[app.subGameName + \"Client\"].GetClientConfigProperty(\"MPID\");\r\n\t    if(!mpID){\r\n\t\t    this.ErrLog(\"SendLoginByWeChatAuthorization not find MPID\");\r\n\t\t    return\r\n\t    }\r\n        this.HeroAccountManager.LoginAccountBySDK(this.ShareDefine.SDKType_WeChatApp, token, mpID, sdkAccountID);\r\n    },\r\n\r\n    //截屏保存方法\r\n    Capture:function(){\r\n    \tlet node = new cc.Node();\r\n\t\tnode.parent = cc.director.getScene();\r\n\t\tlet camera = node.addComponent(cc.Camera);\r\n\r\n\t\tnode.x = cc.winSize.width / 2;\r\n\t\tnode.y = cc.winSize.height / 2;\r\n\r\n\t\t// 设置你想要的截图内容的 cullingMask\r\n\t\tcamera.cullingMask = 0xffffffff;\r\n\r\n\t\t// 新建一个 RenderTexture，并且设置 camera 的 targetTexture 为新建的 RenderTexture，这样 camera 的内容将会渲染到新建的 RenderTexture 中。\r\n\t\tlet texture = new cc.RenderTexture();\r\n\t\tlet gl = cc.game._renderContext;\r\n\t\t// 如果截图内容中不包含 Mask 组件，可以不用传递第三个参数 gl.STENCIL_INDEX8\r\n\t\ttexture.initWithSize(cc.winSize.width, cc.winSize.height, gl.STENCIL_INDEX8);\r\n\t\tcamera.targetTexture = texture;\r\n\r\n\t\t// 渲染一次摄像机，即更新一次内容到 RenderTexture 中\r\n\t\tcamera.render();\r\n\r\n\t\t// 这样我们就能从 RenderTexture 中获取到数据了\r\n\t\tlet data = texture.readPixels();\r\n\r\n\t\t//以下代码将截图后默认倒置的图片回正\r\n\t\tlet width = Math.floor(cc.winSize.width);\r\n        let height = Math.floor(cc.winSize.height);\r\n        console.log(\"width === \" + width + \",height === \" + height);\r\n        let picData = new Uint8Array(width * height * 4);\r\n        let rowBytes = width * 4;\r\n        for (let row = 0; row < height; row++) {\r\n            let srow = height - 1 - row;\r\n            let start = Math.floor(srow * width * 4);\r\n            let reStart = row * width * 4;\r\n            // save the piexls data\r\n            for (let i = 0; i < rowBytes; i++) {\r\n                picData[reStart + i] = data[start + i];\r\n            }\r\n        }\r\n\t\t// 接下来就可以对这些数据进行操作了\r\n\t\tif (CC_JSB) {\r\n\t\t\tlet name =   Math.floor(Date.now())  + '.png';\r\n\t\t\tvar filePath = jsb.fileUtils.getWritablePath() + name;\r\n\t\t\tlet success = jsb.saveImageData(picData, width, height, filePath);\r\n\t\t\tnode.destroy();\r\n\t\t\tif (success) {\r\n\t            console.log(\"ShareScreen imagePath=%s\",filePath);\r\n\t\t\t\treturn filePath;\r\n\t        }\r\n\t        else {\r\n\t            console.log(\"save image data failed!\");\r\n\t            return \"\";\r\n\t        }\r\n\t\t}\r\n    },\r\n});\r\n\r\n\r\nvar g_ddz_WeChatAppManager = null;\r\n\r\n/**\r\n * 绑定模块外部方法\r\n */\r\nexports.GetModel = function(){\r\n    if(!g_ddz_WeChatAppManager){\r\n        g_ddz_WeChatAppManager = new ddz_WeChatAppManager();\r\n    }\r\n    return g_ddz_WeChatAppManager;\r\n};\r\n"]}