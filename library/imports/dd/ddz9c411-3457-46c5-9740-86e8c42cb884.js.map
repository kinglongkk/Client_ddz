{"version":3,"sources":["../../../../../assets/script/scene/assets/script/scene/ddz_SceneManager.js"],"names":["app","require","ddz_SceneManager","BaseClass","extend","Init","JS_Name","SceneInfo","ddz_SysDataManager","GetTableDict","backMusicSoundID","beforeBackMusicSoundName","mapID","sceneName","sceneComponent","loadingNode","isLoading","loadingSceneName","subGameName","RegEvent","OnEvent_ModalLayer","OnEvent_OnShakeScene","Log","event","WarnLog","OnTopEvent","OnEventHide","OnEventShow","bReConnect","OnShakeScene","LoadScene","isReLoad","console","log","ddz_FormManager","loadFormDict","showFormDict","createingFormDict","formWndShowInfo","defaultFormNameList","that","cc","loader","loadRes","err","prefab","instantiate","game","addPersistRootNode","ReadyLoadScene","hasOwnProperty","ErrLog","lastSceneName","lastSceneScriptName","lastSceneScript","find","getComponent","bluebirdObj","LoadSceneDefaultForm","then","StartLoadScene","catch","error","stack","formPath2RealPath","formPath","indexOf","RealGamePrefab","GamePrefab","is3DShow","LocalDataManager","GetConfigProperty","gamePrefab","OnBeforeExitScene","director","loadScene","OnLoadSceneEnd","bind","ddz_ControlManager","CreateLoadPromise","preloadScene","ShowHelp","eventID","eventNode","PlayMusic","backGroundSound","StopSceneMusic","ddz_SoundManager","PlayBackMusic","soundID","PauseSceneMusic","PauseSound","RecoverySceneMusic","ResumeSound","StopSoundByAudioID","UpdateSceneMusic","volume","audioEngine","setVolume","removePersistRootNode","removeFromParent","sceneScriptName","node","c","Canvas","heightWidth","winSize","height","width","IsIpad","fitWidth","FormManager","OnSwithSceneEnd","OnShowDefaultForm","OnTimer","passSecond","OnBaseTimer","OnReload","isFirstEnterMainScene","GetSceneType","GetSceneComponent","GetMapID","g_ddz_SceneManager","exports","GetModel"],"mappings":"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","file":"ddz_SceneManager.js","sourceRoot":"../../../../../assets/script/scene","sourcesContent":["/*\r\n\t场景管理器\r\n*/\r\n\r\nvar app = require(\"ddz_app\");\r\n\r\nvar ddz_SceneManager = app.BaseClass.extend({\r\n\r\n    Init:function(){\r\n    \tthis.JS_Name = app[\"subGameName\"] + \"_SceneManager\";\r\n\r\n        this.SceneInfo = app.ddz_SysDataManager().GetTableDict(\"SceneInfo\");\r\n\r\n        this.backMusicSoundID = -1;\r\n        this.beforeBackMusicSoundName = \"\";\r\n\r\n        this.mapID = 0;\r\n        this.sceneName = \"\";\r\n        //当前场景的组件对象\r\n        this.sceneComponent = null;\r\n\r\n        this.loadingNode = null;\r\n\r\n        this.isLoading = false;\r\n        this.loadingSceneName = \"\";\r\n\r\n        app[app.subGameName + \"Client\"].RegEvent(\"ModalLayer\", this.OnEvent_ModalLayer, this);\r\n\t    app[app.subGameName + \"Client\"].RegEvent(\"ShakeScene\",this.OnEvent_OnShakeScene, this);\r\n\r\n    \tthis.Log(\"Init\");\r\n    },\r\n\r\n    //---------------回掉事件---------------\r\n    //显示最顶层layer\r\n    OnEvent_ModalLayer:function(event){\r\n        if(!this.sceneComponent){\r\n            this.WarnLog(\"OnEvent_ModalLayer not sceneName\");\r\n            return\r\n        }\r\n        this.sceneComponent.OnTopEvent(event);\r\n    },\r\n\r\n    //应用切入后台\r\n    OnEventHide:function(){\r\n        if(!this.sceneComponent){\r\n            this.WarnLog(\"OnEventHide not sceneName\");\r\n            return\r\n        }\r\n        this.sceneComponent.OnEventHide();\r\n    },\r\n\r\n    //应用显示\r\n    OnEventShow:function(bReConnect){\r\n        if(!this.sceneComponent){\r\n            this.WarnLog(\"OnEventShow not sceneName\");\r\n            return\r\n        }\r\n        this.sceneComponent.OnEventShow(bReConnect);\r\n    },\r\n\r\n\tOnEvent_OnShakeScene:function(){\r\n\t\tif(!this.sceneComponent){\r\n\t\t\tthis.WarnLog(\"OnEvent_ModalLayer not sceneName\");\r\n\t\t\treturn\r\n\t\t}\r\n\t\tthis.sceneComponent.OnShakeScene();\r\n\t},\r\n    //---------------外部操作接口----------------\r\n\r\n    //切换场景\r\n    LoadScene:function(sceneName, mapID=0, isReLoad=false){\r\n        \r\n        if (this.loadingSceneName == sceneName) {\r\n            console.log(sceneName + \" 场景已经在加载中...\");\r\n            return;\r\n        }\r\n        this.loadingSceneName = sceneName;\r\n        if (isReLoad) {\r\n            //如果是游戏切换需要释放内存，重新加载\r\n            //清理已经加载的界面\r\n            app.ddz_FormManager().loadFormDict = {};\r\n            app.ddz_FormManager().showFormDict = {};\r\n            app.ddz_FormManager().createingFormDict = {};\r\n            app.ddz_FormManager().formWndShowInfo = {};\r\n            app.ddz_FormManager().defaultFormNameList = [];\r\n        }\r\n        if(sceneName!='loginScene'){\r\n            // app.ddz_FormManager().ShowForm(\"UIWaitForm\");\r\n            let that = this;\r\n            cc.loader.loadRes(\"ui/ddz_UIWaitForm\", function (err, prefab) {\r\n                that.loadingNode = cc.instantiate(prefab);\r\n                console.log(\"load uiwaitform\");\r\n                cc.game.addPersistRootNode(that.loadingNode);\r\n                that.isLoading = true;\r\n                that.ReadyLoadScene(sceneName,mapID);\r\n            });\r\n\r\n        }else{\r\n            if(!this.SceneInfo.hasOwnProperty(sceneName)){\r\n                this.ErrLog(\"LoadScene(%s) SceneInfo.txt not find\", sceneName);\r\n                return\r\n            }\r\n\r\n            if(this.isLoading){\r\n                this.ErrLog(\"LoadScene(%s) fail doing (%s) loading now\", sceneName, this.sceneName);\r\n                return\r\n            }\r\n\r\n            this.isLoading = true;\r\n            this.ReadyLoadScene(sceneName,mapID);\r\n\r\n        }\r\n\r\n        \r\n        // let that = this;\r\n        // if('clubScene' == sceneName){\r\n        //     app.ClubManager().ChangeOrientationH(false,function(){\r\n        //         that.ReadyLoadScene(sceneName,mapID);\r\n        //     });\r\n        // }\r\n        // else{\r\n        //     if(!app.ddz_FormManager()._isOrientationH()){\r\n        //         app.ClubManager().ChangeOrientationH(true,function(){\r\n        //             that.ReadyLoadScene(sceneName,mapID);\r\n        //         });\r\n        //     }\r\n        //     else{\r\n        //         that.ReadyLoadScene(sceneName,mapID);\r\n        //     }\r\n        // }\r\n    },\r\n    ReadyLoadScene:function(sceneName,mapID){\r\n        let lastSceneName = this.sceneName;\r\n        this.Log(\"LoadScene((%s,%s) -> (%s,%s))\", lastSceneName, this.mapID, sceneName, mapID);\r\n        this.mapID = mapID;\r\n        this.sceneName = sceneName;\r\n        let lastSceneScriptName = \"\";\r\n        let lastSceneScript = null;\r\n        let that = this;\r\n        //如果前一个场景不是启动场景\r\n        if(this.SceneInfo.hasOwnProperty(lastSceneName)){\r\n            lastSceneScriptName = this.SceneInfo[lastSceneName][\"ComponentName\"];\r\n            //找到场景对应的脚本组件\r\n            \r\n            lastSceneScript = cc.find('Canvas').getComponent(lastSceneScriptName);\r\n        }\r\n\r\n        let bluebirdObj = app.ddz_FormManager().LoadSceneDefaultForm(sceneName);\r\n\r\n        //如果返回异步对象,需要登录异步执行完成,在进入切换场景\r\n        if(bluebirdObj){\r\n            bluebirdObj.then(function(){\r\n                    that.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\r\n                })\r\n                .catch(function(error){\r\n                    that.ErrLog(\"LoadSceneDefaultForm(%s) error:%s\", sceneName, error.stack);\r\n\r\n                    that.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\r\n                })\r\n        }\r\n        else{\r\n            this.StartLoadScene(lastSceneScript, lastSceneScriptName, sceneName);\r\n        }\r\n    },\r\n    formPath2RealPath:function(formPath){\r\n        if(formPath.indexOf('/')<1){\r\n            return 'ui/'+formPath;\r\n        }\r\n        return formPath;\r\n    },\r\n    RealGamePrefab:function(GamePrefab){\r\n            let is3DShow=app.LocalDataManager().GetConfigProperty(\"SysSetting\", \"is3DShow\");\r\n            if(is3DShow==0 && GamePrefab=='game/ZJMJ/ui/UIZJMJPlay'){\r\n                 //2D场景需要切换\r\n                 GamePrefab='game/ZJMJ/ui/UIZJMJ2DPlay';\r\n            }\r\n            if(is3DShow==2 && GamePrefab=='game/ZJMJ/ui/UIZJMJPlay'){\r\n                 //2D场景需要切换\r\n                 GamePrefab='game/ZJMJ/ui/UIZJMJKXPlay';\r\n            }\r\n            if(is3DShow==3 && GamePrefab=='game/ZJMJ/ui/UIZJMJPlay'){\r\n                 //2D场景需要切换\r\n                 GamePrefab='game/ZJMJ/ui/UIZJMJ17Play';\r\n            }\r\n            return this.formPath2RealPath(GamePrefab);\r\n    },\r\n\tStartLoadScene:function(lastSceneScript, lastSceneScriptName, sceneName){\r\n        //预加载有戏场景开始\r\n        // console.log(\"StartLoadScene sceneName == \" + sceneName);\r\n        // console.log(\"StartLoadScene SceneInfo == \" + JSON.stringify(this.SceneInfo));\r\n        let GamePrefab=this.SceneInfo[sceneName].gamePrefab;\r\n        let that = this;\r\n        if(GamePrefab==0){\r\n            //退出当前场景\r\n            if(lastSceneScript){\r\n                lastSceneScript.OnBeforeExitScene();\r\n            }\r\n            //关闭场景界面和模型\r\n            app.ddz_FormManager().OnBeforeExitScene(lastSceneScriptName);\r\n            //加载失败,也要切换进场景\r\n            this.sceneComponent = null;\r\n            cc.director.loadScene(sceneName, that.OnLoadSceneEnd.bind(that));\r\n            \r\n        }else{\r\n            app.ddz_ControlManager().CreateLoadPromise(this.RealGamePrefab(GamePrefab))\r\n            .then(function(prefab){\r\n                //退出当前场景\r\n                //加载失败,也要切换进场景\r\n                that.sceneComponent = null;\r\n                cc.director.preloadScene(sceneName, function () {\r\n                    \r\n                    if(lastSceneScript){\r\n                        lastSceneScript.OnBeforeExitScene();\r\n                    }\r\n                    //关闭场景界面和模型\r\n                    app.ddz_FormManager().OnBeforeExitScene(lastSceneScriptName);\r\n\r\n                    cc.director.loadScene(sceneName, that.OnLoadSceneEnd.bind(that));\r\n                });\r\n                return;\r\n            })\r\n            .catch(function(error){\r\n                //\r\n            })\r\n        }\r\n        //预加载有戏场景\r\n\t\t\r\n\t},\r\n\r\n    ShowHelp:function(eventID, eventNode){\r\n        if(this.sceneComponent){\r\n            this.sceneComponent.ShowHelp(eventID, eventNode);\r\n        }\r\n    },\r\n\r\n    //播放背景音乐\r\n    PlayMusic:function(backGroundSound){\r\n\r\n        if(!this.SceneInfo.hasOwnProperty(this.sceneName)){\r\n            this.ErrLog(\"PlayMusic failed, SceneInfo.txt not find:%s\", this.sceneName);\r\n            return\r\n        }\r\n\r\n        if(!backGroundSound){\r\n            backGroundSound = this.SceneInfo[this.sceneName][\"BackGroundSound\"];\r\n            //读取缓存的背景音乐\r\n            if(backGroundSound != \"\" && backGroundSound != \"0\"){\r\n                backGroundSound=app.LocalDataManager().GetConfigProperty(\"SysSetting\",\"MainBackMusic\");\r\n            }\r\n            //读取缓存的背景音乐\r\n        }\r\n\r\n        if(backGroundSound == \"0\"){\r\n            return\r\n        }\r\n\r\n        //如果切换场景时，两个场景播放的背景音乐相同则不需要再次播放\r\n        // if(this.beforeBackMusicSoundName == backGroundSound){\r\n        //     return;\r\n        // }\r\n        //如果背景音乐不同，则先停止上一个场景残留的背景音乐，重新播放新的背景音乐\r\n        this.StopSceneMusic();\r\n        this.beforeBackMusicSoundName = backGroundSound;\r\n\r\n        let that = this;\r\n        app.ddz_SoundManager().PlayBackMusic(backGroundSound)\r\n            .then(function(soundID){\r\n                that.backMusicSoundID = soundID;\r\n            })\r\n    },\r\n\r\n    PauseSceneMusic:function () {\r\n        if(this.backMusicSoundID != -1){\r\n            app.ddz_SoundManager().PauseSound(this.backMusicSoundID);\r\n        }\r\n    },\r\n    RecoverySceneMusic:function () {\r\n        if(this.backMusicSoundID != -1){\r\n            app.ddz_SoundManager().ResumeSound(this.backMusicSoundID);\r\n        }\r\n    },\r\n\tStopSceneMusic:function(){\r\n\t\tif(this.backMusicSoundID != -1){\r\n            app.ddz_SoundManager().StopSoundByAudioID(this.backMusicSoundID);\r\n\t\t}\r\n\t},\r\n    UpdateSceneMusic:function () {\r\n        if(this.backMusicSoundID != -1){\r\n            let volume = app.LocalDataManager().GetConfigProperty(\"SysSetting\",\"BackVolume\");\r\n            cc.audioEngine.setVolume(this.backMusicSoundID, volume);\r\n        }\r\n    },\r\n    //------------回掉函数-------------------\r\n\r\n    //场景加载完成回掉\r\n    OnLoadSceneEnd:function(){\r\n        this.Log(\"OnLoadSceneEnd sceneName:%s\", this.sceneName);\r\n\r\n        this.isLoading = false;\r\n        this.loadingSceneName = \"\";\r\n        console.log(\"unload uiwaitform  begein\");\r\n        if (this.loadingNode) {\r\n            cc.game.removePersistRootNode(this.loadingNode);\r\n            this.loadingNode.removeFromParent();\r\n            this.loadingNode=null;\r\n            console.log(\"unload uiwaitform success\");\r\n        }\r\n\t\t\r\n\t\tif(!this.SceneInfo.hasOwnProperty(this.sceneName)){\r\n\t\t\tthis.ErrLog(\"OnLoadSceneEnd SceneInfo.txt not find:(%s)\", this.sceneName);\r\n\t\t\treturn \r\n        }\r\n\t    let sceneScriptName = this.SceneInfo[this.sceneName][\"ComponentName\"];\r\n\t    //找到场景对应的脚本组件\r\n\t    this.sceneComponent = cc.find('Canvas').getComponent(sceneScriptName);\r\n        //ipad适配\r\n        let node=cc.find('Canvas');\r\n        let c=node.getComponent(cc.Canvas);\r\n        let heightWidth = cc.winSize.height/cc.winSize.width;\r\n        if(app[app.subGameName+\"_ComTool\"]().IsIpad() || heightWidth > 0.6){\r\n            c.fitWidth=true;\r\n        }else{\r\n            c.fitWidth=false;\r\n        }\r\n\r\n        let FormManager = app.ddz_FormManager();\r\n\r\n        FormManager.OnSwithSceneEnd(this.sceneName);\r\n        if (this.sceneComponent) {\r\n            this.sceneComponent.OnShowDefaultForm();\r\n            this.sceneComponent.OnSwithSceneEnd();\r\n        }else{\r\n            console.log(\"找不到场景上绑定的组件:\" + sceneScriptName);\r\n        }\r\n\t    \r\n\r\n\t    this.PlayMusic();\r\n    },\r\n\r\n    //定时回掉\r\n    OnTimer:function(passSecond){\r\n        if(this.sceneComponent){\r\n            this.sceneComponent.OnBaseTimer(passSecond);\r\n        }\r\n    },\r\n\r\n    //切换账号\r\n    OnReload:function(){\r\n        this.isFirstEnterMainScene = true;\r\n    },\r\n    //-----------------获取接口---------------------------\r\n\r\n    //获取当前加载的场景名\r\n    GetSceneType:function(){\r\n    \treturn this.sceneName;\r\n    },\r\n\r\n    //获取当前场景的组件对象\r\n    GetSceneComponent:function(){\r\n        return this.sceneComponent\r\n    },\r\n\r\n    //获取当前场景的地图ID\r\n    GetMapID:function(){\r\n        return this.mapID\r\n    },\r\n});\r\n\r\n\r\n\r\nvar g_ddz_SceneManager = null;\r\n\r\n/**\r\n * 绑定模块外部方法\r\n */\r\nexports.GetModel = function(){\r\n    if(!g_ddz_SceneManager){\r\n        g_ddz_SceneManager = new ddz_SceneManager();\r\n    }\r\n    return g_ddz_SceneManager;\r\n}\r\n\r\n"]}