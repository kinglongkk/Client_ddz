{"version":3,"sources":["../../../../../assets/script/common/assets/script/common/ddz_HotUpdateMgr.js"],"names":["app","require","ddz_HotUpdateMgr","BaseClass","extend","Init","console","log","_storagePath","jsb","fileUtils","getWritablePath","subGameName","LocalVersion","cc","sys","localStorage","getItem","_updating","isDirectoryExist","createDirectory","isNative","UIRLFILE","manifestPath","isFileExist","_am","AssetsManager","versionCompareHandle","bind","loadLocalManifest","getLocalManifest","getVersion","setItem","customManifestStr","JSON","stringify","manifest","Manifest","setVerifyCallback","path","asset","compressed","relativePath","os","OS_ANDROID","setMaxConcurrentTask","versionA","versionB","vA","split","vB","i","length","a","parseInt","b","SaveManifest","path_Manifest","file","self","downloader","Downloader","setOnFileTaskSuccess","manifestContent","getStringFromFile","manifestJson","parse","version","RestartApp","setOnTaskError","SysNotifyManager","ShowSysMsg","createDownloadFileTask","getLocalVersion","CheckUpdate","isLoaded","setEventCallback","CheckCb","checkUpdate","event","code","getEventCode","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","OnEvent","NEW_VERSION_FOUND","HotUpdate","updateCount","UpdateCb","getRemoteManifest","_failCount","update","failed","needRestart","UPDATE_PROGRESSION","getDownloadedBytes","getTotalBytes","bytes","total","ASSET_UPDATED","getAssetId","UPDATE_FINISHED","remoteManifest","error","getManifestFile","writeFile","e","message","UPDATE_FAILED","downloadFailedAssets","ERROR_UPDATING","getMessage","ERROR_DECOMPRESS","searchPaths","getSearchPaths","newPaths","Array","prototype","unshift","apply","setSearchPaths","game","restart","Destroy","g_ddz_HotUpdateMgr","exports","GetModel"],"mappings":"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","file":"ddz_HotUpdateMgr.js","sourceRoot":"../../../../../assets/script/common","sourcesContent":["var app = require('ddz_app');\r\n\r\nvar ddz_HotUpdateMgr = app.BaseClass.extend({\r\n    Init: function () {\r\n        console.log('ddz_HotUpdateMgr Init - Start');\r\n        this._storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'ALLGame/' + app.subGameName);\r\n        this.LocalVersion = cc.sys.localStorage.getItem('LocalVersion_' + app.subGameName) || '';\r\n        this._updating = false;\r\n\r\n        // 确保存储目录存在\r\n        if (!jsb.fileUtils.isDirectoryExist(this._storagePath)) {\r\n            console.log('ddz_HotUpdateMgr Init - Creating directory: ' + this._storagePath);\r\n            jsb.fileUtils.createDirectory(this._storagePath);\r\n        } else {\r\n            console.log('ddz_HotUpdateMgr Init - Directory exists, no cleanup performed');\r\n        }\r\n\r\n        if (!cc.sys.isNative) {\r\n            console.log(\"Not native, exiting hot update: \" + cc.sys.isNative);\r\n            return;\r\n        }\r\n\r\n        console.log(\"Storage path for remote assets: \" + this._storagePath);\r\n        var UIRLFILE = \"http://185.213.26.71:82/\" + app.subGameName + \"/remote-assets\";\r\n\r\n        // 优先加载本地清单文件\r\n        var manifestPath = this._storagePath + '/project.manifest';\r\n        if (jsb.fileUtils.isFileExist(manifestPath)) {\r\n            console.log('ddz_HotUpdateMgr Init - Loading existing manifest: ' + manifestPath);\r\n            this._am = new jsb.AssetsManager(manifestPath, this._storagePath, this.versionCompareHandle.bind(this));\r\n            this._am.loadLocalManifest(manifestPath);\r\n            this.LocalVersion = this._am.getLocalManifest().getVersion();\r\n            cc.sys.localStorage.setItem('LocalVersion_' + app.subGameName, this.LocalVersion);\r\n        } else {\r\n            console.log('ddz_HotUpdateMgr Init - Creating new manifest');\r\n            var customManifestStr = JSON.stringify({\r\n                'packageUrl': UIRLFILE,\r\n                'remoteManifestUrl': UIRLFILE + '/project.manifest',\r\n                'remoteVersionUrl': UIRLFILE + '/version.manifest',\r\n                'version': '0.0.1',\r\n                'assets': {},\r\n                'searchPaths': []\r\n            });\r\n            this._am = new jsb.AssetsManager('', this._storagePath, this.versionCompareHandle.bind(this));\r\n            var manifest = new jsb.Manifest(customManifestStr, this._storagePath);\r\n            this._am.loadLocalManifest(manifest, this._storagePath);\r\n            this.LocalVersion = '0.0.1';\r\n            cc.sys.localStorage.setItem('LocalVersion_' + app.subGameName, this.LocalVersion);\r\n        }\r\n\r\n        this._am.setVerifyCallback(function (path, asset) {\r\n            var compressed = asset.compressed;\r\n            var relativePath = asset.path;\r\n            if (compressed) {\r\n                console.log(\"Verification passed (compressed): \" + relativePath);\r\n                return true;\r\n            } else {\r\n                console.log(\"Verification passed (no MD5 check): \" + relativePath);\r\n                return true;\r\n            }\r\n        });\r\n\r\n        if (cc.sys.os === cc.sys.OS_ANDROID) {\r\n            this._am.setMaxConcurrentTask(2);\r\n        }\r\n    },\r\n\r\n    versionCompareHandle: function (versionA, versionB) {\r\n        console.log(\"JS Custom Version Compare: version A is \" + versionA + ', version B is ' + versionB);\r\n        var vA = versionA.split('.');\r\n        var vB = versionB.split('.');\r\n        for (var i = 0; i < vA.length; ++i) {\r\n            var a = parseInt(vA[i]);\r\n            var b = parseInt(vB[i] || 0);\r\n            if (a === b) continue;\r\n            return a - b;\r\n        }\r\n        return vB.length > vA.length ? -1 : 0;\r\n    },\r\n\r\n    SaveManifest: function () {\r\n        console.log(\"SaveManifest begin for \" + app.subGameName);\r\n        let path_Manifest = \"http://185.213.26.71:82/\" + app.subGameName + \"/remote-assets/project.manifest\";\r\n        let file = this._storagePath + '/project.manifest';\r\n        let self = this;\r\n        var downloader = new jsb.Downloader();\r\n        downloader.setOnFileTaskSuccess(function () {\r\n            console.log(\"downFile2Local: project.manifest downloaded successfully for \" + app.subGameName);\r\n            let manifestContent = jsb.fileUtils.getStringFromFile(file);\r\n            let manifestJson = JSON.parse(manifestContent);\r\n            self.LocalVersion = manifestJson.version || self.LocalVersion;\r\n            cc.sys.localStorage.setItem('LocalVersion_' + app.subGameName, self.LocalVersion);\r\n            console.log(\"Updated LocalVersion to: \" + self.LocalVersion);\r\n            self.RestartApp();\r\n        });\r\n        downloader.setOnTaskError(function () {\r\n            console.log(\"downFile2Local: project.manifest download failed for \" + app.subGameName);\r\n            app.SysNotifyManager().ShowSysMsg(\"下载Manifest失败，更新可能不完整...\", [], 3);\r\n            self.RestartApp();\r\n        });\r\n        downloader.createDownloadFileTask(path_Manifest, file);\r\n    },\r\n\r\n    getLocalVersion: function () {\r\n        console.log(\"getLocalVersion for \" + app.subGameName + \": \" + this.LocalVersion);\r\n        if (this.LocalVersion === '' && this._am && !this._updating) {\r\n            this.LocalVersion = this._am.getLocalManifest().getVersion();\r\n            cc.sys.localStorage.setItem('LocalVersion_' + app.subGameName, this.LocalVersion);\r\n        }\r\n        return this.LocalVersion;\r\n    },\r\n\r\n    CheckUpdate: function () {\r\n        if (!cc.sys.isNative) {\r\n            console.log(\"Not native, skipping update check\");\r\n            return;\r\n        }\r\n        if (this._updating) {\r\n            console.log(\"Update in progress, cannot check...\");\r\n            app.SysNotifyManager().ShowSysMsg(\"正在更新，无法检测...\", [], 3);\r\n            return;\r\n        }\r\n        if (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\r\n            console.log(\"Failed to load local manifest for \" + app.subGameName);\r\n            app.SysNotifyManager().ShowSysMsg(\"加载本地Manifest失败...\", [], 3);\r\n            return;\r\n        }\r\n        this._am.setEventCallback(this.CheckCb.bind(this));\r\n        this._am.checkUpdate();\r\n        this._updating = true;\r\n    },\r\n\r\n    CheckCb: function (event) {\r\n        let code = event.getEventCode();\r\n        console.log(\"CheckCb event for \" + app.subGameName + \": \" + code);\r\n        switch (code) {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                console.log(\"No local manifest file found, update cannot proceed\");\r\n                app.SysNotifyManager().ShowSysMsg(\"找不到本地Manifest文件...\", [], 3);\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                console.log(\"Failed to download/parse manifest, check network or server\");\r\n                app.SysNotifyManager().ShowSysMsg(\"下载或解析Manifest失败...\", [], 3);\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                console.log(\"Already up to date for \" + app.subGameName);\r\n                cc.sys.localStorage.setItem('updateCount_' + app.subGameName, 0);\r\n                app[app.subGameName + \"Client\"].OnEvent('UpToDate');\r\n                break;\r\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\r\n                console.log(\"New version found for \" + app.subGameName + \", starting update\");\r\n                this.HotUpdate();\r\n                break;\r\n            default:\r\n                console.log(\"CheckCb unknown event for \" + app.subGameName + \": \" + code);\r\n                break;\r\n        }\r\n        this._am.setEventCallback(null);\r\n        this._updating = false;\r\n    },\r\n\r\n    HotUpdate: function () {\r\n        if (this._am && !this._updating) {\r\n            let updateCount = parseInt(cc.sys.localStorage.getItem('updateCount_' + app.subGameName) || 0);\r\n            if (updateCount >= 1) {\r\n                console.log(\"Update limit reached for \" + app.subGameName + \", skipping update\");\r\n                app[app.subGameName + \"Client\"].OnEvent('UpdateLimitReached');\r\n                return;\r\n            }\r\n            this._am.setEventCallback(this.UpdateCb.bind(this));\r\n            this.LocalVersion = this._am.getLocalManifest().getVersion();\r\n            console.log(\"LocalVersion for \" + app.subGameName + \": \" + this.LocalVersion);\r\n            console.log(\"RemoteVersion for \" + app.subGameName + \": \" + (this._am.getRemoteManifest() ? this._am.getRemoteManifest().getVersion() : \"Not loaded\"));\r\n            this._failCount = 0;\r\n            this._am.update();\r\n            this._updating = true;\r\n            cc.sys.localStorage.setItem('updateCount_' + app.subGameName, updateCount + 1);\r\n        }\r\n    },\r\n\r\n    UpdateCb: function (event) {\r\n        var failed = false;\r\n        var needRestart = false;\r\n        console.log(\"UpdateCb event for \" + app.subGameName + \": \" + event.getEventCode());\r\n        switch (event.getEventCode()) {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                console.log(\"No local manifest file found for \" + app.subGameName);\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                console.log(\"Fail to download/parse manifest for \" + app.subGameName);\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                console.log(\"Already up to date for \" + app.subGameName);\r\n                cc.sys.localStorage.setItem('updateCount_' + app.subGameName, 0);\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\r\n                console.log(\"Progress for \" + app.subGameName + \": \" + event.getDownloadedBytes() + \"/\" + event.getTotalBytes());\r\n                app[app.subGameName + \"Client\"].OnEvent('UpdateProgress', { bytes: event.getDownloadedBytes(), total: event.getTotalBytes() });\r\n                break;\r\n            case jsb.EventAssetsManager.ASSET_UPDATED:\r\n                console.log(\"Asset updated for \" + app.subGameName + \": \" + event.getAssetId());\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\r\n                console.log(\"Update finished for \" + app.subGameName);\r\n                let remoteManifest = this._am.getRemoteManifest();\r\n                if (!remoteManifest) {\r\n                    console.error(\"Remote manifest is null, falling back to SaveManifest\");\r\n                    needRestart = true;\r\n                } else {\r\n                    let manifestPath = this._storagePath + '/project.manifest';\r\n                    try {\r\n                        let manifestContent = remoteManifest.getManifestFile();\r\n                        if (manifestContent) {\r\n                            jsb.fileUtils.writeFile(manifestPath, manifestContent);\r\n                            console.log(\"Saved updated manifest to: \" + manifestPath);\r\n                            this.LocalVersion = remoteManifest.getVersion() || this.LocalVersion;\r\n                            cc.sys.localStorage.setItem('LocalVersion_' + app.subGameName, this.LocalVersion);\r\n                            needRestart = true;\r\n                        } else {\r\n                            console.error(\"Manifest content is empty, falling back to SaveManifest\");\r\n                            needRestart = true;\r\n                        }\r\n                    } catch (e) {\r\n                        console.error(\"Error saving manifest: \" + e.message);\r\n                        needRestart = true;\r\n                    }\r\n                }\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FAILED:\r\n                console.log(\"Update failed for \" + app.subGameName + \", retrying...\");\r\n                this._am.downloadFailedAssets();\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_UPDATING:\r\n                console.log(\"Asset update error for \" + app.subGameName + \": \" + event.getAssetId() + \", \" + event.getMessage());\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\r\n                console.log(\"Decompress error for \" + app.subGameName + \": \" + event.getMessage());\r\n                break;\r\n        }\r\n        if (failed) {\r\n            this._am.setEventCallback(null);\r\n            this._updating = false;\r\n            app[app.subGameName + \"Client\"].OnEvent('UpdateFailed');\r\n        }\r\n        if (needRestart) {\r\n            this.SaveManifest();\r\n        }\r\n    },\r\n\r\n    RestartApp: function () {\r\n        console.log(\"RestartApp begin for \" + app.subGameName);\r\n        var searchPaths = jsb.fileUtils.getSearchPaths();\r\n        var newPaths = this._am.getLocalManifest().getSearchPaths();\r\n        Array.prototype.unshift.apply(searchPaths, newPaths);\r\n        cc.sys.localStorage.setItem('HotUpdateSearchPaths_' + app.subGameName, JSON.stringify(searchPaths));\r\n        jsb.fileUtils.setSearchPaths(searchPaths);\r\n        if (!jsb.fileUtils.isFileExist(this._storagePath + '/project.manifest')) {\r\n            console.error(\"Manifest file missing after update for \" + app.subGameName);\r\n            app[app.subGameName + \"Client\"].OnEvent('ManifestMissing');\r\n            return;\r\n        }\r\n        console.log(\"Restarting game with search paths: \" + JSON.stringify(searchPaths));\r\n        cc.game.restart();\r\n    },\r\n\r\n    Destroy: function () {\r\n        this._am.setEventCallback(null);\r\n        this._updating = false;\r\n        console.log(\"ddz_HotUpdateMgr Destroyed\");\r\n    }\r\n});\r\n\r\nvar g_ddz_HotUpdateMgr = null;\r\n\r\nexports.GetModel = function () {\r\n    if (!g_ddz_HotUpdateMgr)\r\n        g_ddz_HotUpdateMgr = new ddz_HotUpdateMgr();\r\n    return g_ddz_HotUpdateMgr;\r\n}"]}